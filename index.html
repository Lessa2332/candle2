<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>üïØÔ∏è –°–≤—ñ—á–∫–∞ –ü–∞–º‚Äô—è—Ç—ñ</title>

  <!-- A-Frame + MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: 'Inter', sans-serif;
    }
    #hint {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 16px;
      text-align: center;
      max-width: 90%;
      z-index: 1000;
    }
    #ui {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      text-align: center;
    }
    button {
      background: #d4af37;
      color: black;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 30px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    button:hover { opacity: 0.9; }
    button:disabled { background: #555; color: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>
  <div id="hint">–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –ø–∞–º‚Äô—è—Ç—ñ</div>
  <div id="ui">
    <button id="speakBtn" disabled>üïØÔ∏è –ü—Ä–æ–≥–æ–≤–æ—Ä—ñ—Ç—å –ø–æ–¥—è–∫—É</button>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    embedded
    renderer="colorManagement: true; alpha: true;"
  >
    <a-assets>
      <audio id="gratitudeSound" src="message.mp3" preload="auto"></audio>
    </a-assets>

    <a-camera position="0 0 0.8"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="candleTarget">
      <!-- –û—Å–Ω–æ–≤–∞ —Å–≤—ñ—á–∫–∏: –±—ñ–ª–∏–π —Ü–∏–ª—ñ–Ω–¥—Ä -->
      <a-cylinder
        position="0 0.08 0"
        radius="0.08"
        height="0.16"
        color="#f8f8f8"
        shadow="cast: true"
      ></a-cylinder>

      <!-- –§—ñ—Ç—ñ–ª—å -->
      <a-cylinder
        position="0 0.17 0"
        radius="0.005"
        height="0.02"
        color="#222"
      ></a-cylinder>

      <!-- –ü–æ–ª—É–º‚Äô—è (—Å—Ñ–µ—Ä–∞ –∑ –µ–º—ñ—Å—ñ—î—é) -->
      <a-entity
        id="flame"
        geometry="primitive: sphere; radius: 0.05;"
        material="color: #ffaa00; emissive: #ff5500; emissiveIntensity: 1.2; opacity: 0.9; transparent: true; blending: additive;"
        position="0 0.19 0"
        scale="1 1.4 1"
      ></a-entity>

      <!-- –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –ø–æ–ª—É–º‚Äô—è -->
      <a-light
        id="flameLight"
        type="point"
        color="#ffcc88"
        intensity="0.3"
        distance="1.0"
        decay="2"
        position="0 0.19 0"
      ></a-light>
    </a-entity>

    <a-sky color="#000000"></a-sky>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const speakBtn = document.getElementById('speakBtn');
      const flame = document.getElementById('flame');
      const flameLight = document.getElementById('flameLight');
      const candleTarget = document.getElementById('candleTarget');
      const gratitudeAudio = document.getElementById('gratitudeSound');

      let isTargetVisible = false;
      let recognition = null;

      // SpeechRecognition
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'uk-UA';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript.toLowerCase().trim();
          console.log('–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:', transcript);

          if (
            transcript.includes('–¥—è–∫—É—é –∑–∞—Ö–∏—Å–Ω–∏–∫—É') ||
            transcript.includes('–¥—è–∫—É—é –≤–∞–º') ||
            transcript.includes('—Å–ª–∞–≤–∞ –≥–µ—Ä–æ—è–º') ||
            transcript.includes('–≤—ñ—á–Ω–∞—è –ø–∞–º‚Äô—è—Ç—å') ||
            transcript.includes('–¥—è–∫—É—é')
          ) {
            activateCandle();
          }
        };

        recognition.onerror = () => {
          speakBtn.disabled = false;
          speakBtn.textContent = 'üïØÔ∏è –ü—Ä–æ–≥–æ–≤–æ—Ä—ñ—Ç—å –ø–æ–¥—è–∫—É';
        };

        recognition.onend = () => {
          speakBtn.disabled = false;
          speakBtn.textContent = 'üïØÔ∏è –ü—Ä–æ–≥–æ–≤–æ—Ä—ñ—Ç—å –ø–æ–¥—è–∫—É';
        };
      } else {
        speakBtn.textContent = '‚ùå –ú—ñ–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è';
        speakBtn.disabled = true;
      }

      candleTarget.addEventListener('targetFound', () => {
        isTargetVisible = true;
        speakBtn.disabled = false;
      });

      candleTarget.addEventListener('targetLost', () => {
        isTargetVisible = false;
        speakBtn.disabled = true;
      });

      function activateCandle() {
        // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–æ–ª—É–º‚Äô—è
        flame.setAttribute('animation__scale', {
          property: 'scale',
          to: '1.8 2.8 1.8',
          dur: 1000,
          easing: 'easeOutQuad'
        });

        // –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–≤—ñ—Ç–ª–∞
        flameLight.setAttribute('animation__intensity', {
          property: 'intensity',
          to: '1.4',
          dur: 1000,
          easing: 'easeOutQuad'
        });

        // –ó–≤—É–∫
        gratitudeAudio.currentTime = 0;
        gratitudeAudio.volume = 0.7;
        gratitudeAudio.play().catch(e => console.warn('–ó–≤—É–∫ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ:', e));

        // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        const msg = document.createElement('div');
        msg.style.cssText = `
          position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
          color: #ffd700; font-size: 24px; font-weight: bold;
          background: rgba(0,0,0,0.7); padding: 12px 24px; border-radius: 12px;
          z-index: 2000; pointer-events: none;
        `;
        msg.textContent = 'üïØÔ∏è –î—è–∫—É—é‚Ä¶';
        document.body.appendChild(msg);
        setTimeout(() => msg.remove(), 3000);
      }

      speakBtn.addEventListener('click', () => {
        if (!recognition || !isTargetVisible) return;
        speakBtn.disabled = true;
        speakBtn.textContent = 'üéôÔ∏è –ì–æ–≤–æ—Ä—ñ—Ç—å‚Ä¶';
        recognition.start();
      });
    });
  </script>
</body>
</html>
